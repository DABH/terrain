variables:
  GIT_SSL_NO_VERIFY: "true"
  GIT_STRATEGY: "clone"
  GET_SOURCES_ATTEMPTS: "3"

# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  paths:
  - node_modules

before_script:
  - yarn
  - ( cd sigint && yarn )
  - ( cd analytics.js && yarn )

stages:
  - lint
  - style
  - test-front
  - test-back
  - test-sigint
  - build
  - deploy
  - fullstack

lint:
  script:
   - yarn run lint-parallel
  stage: lint

style:
  script:
   - yarn run style
  stage: style

test-frontend:
  script:
   - yarn run test-front
  stage: test-front
  when: always

test-backend:
  script:
   - yarn run test-back-setup
   - yarn run test-back
   - yarn run test-back-teardown
  stage: test-back
  when: always
  artifacts:
    paths:
      - coverage

test-sigint:
  script:
    - yarn run test-sigint-setup
    - ( cd sigint && yarn run test )
    - yarn run test-sigint-teardown
  stage: test-sigint
  when: always

build-frontend:
  script:
   - yarn run build
  stage: build
  when: always

build-analytics-js:
  script:
   - ( cd analytics.js && yarn run build )
  stage: build
  when: always

build-frontend-prod:
  script:
   - yarn run build-prod
  only:
   - master
  stage: build

fullstack:
  script:
    - rm -rf ./midway/src/assets/.cache || true;
    - MIDWAY_HOST=`hostname`:3000 yarn run build
    - yarn run test-fullstack-setup
    - killall node || true;
    - NODE_ENV=production yarn run start-midway > ./midwayConsole.log 2>&1&
    - sleep 30
    - yarn run test-rr
    - killall node || true;
    - yarn run test-fullstack-teardown
  stage: fullstack
  when: always

deploy:
  script:
   - MIDWAY_HOST=pa-terraformer01.terrain.int:33000 yarn run build-prod
   - rsync -a --stats ../Search /opt --exclude '*.db' --exclude '.git'
   - fuser -k -n tcp 33000 || true
   - cd /opt/Search && NODE_ENV=production yarn start -- --port 33000 &
  only:
   - master
  stage: deploy
  tags:
    - shell
    - deploy
  when: manual
  environment:
    name: production
    url: http://pa-terraformer01.terrain.int:3000

after_script:
  - killall node || true;
